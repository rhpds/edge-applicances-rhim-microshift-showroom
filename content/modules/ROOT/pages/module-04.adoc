= Module 4: Safe updates & rollbacks
:page-nav-title: Performing an Atomic Update
:icons: font
:source-highlighter: rouge
:experimental:

== Learning objectives
By the end of this module, you will be able to:

* [x] Explain the A/B boot model and atomic update process
* [x] Build an updated appliance image (4.20)
* [x] Perform an update using disconnected workflows
* [x] Export and import images using directory transport
* [x] Verify successful updates using greenboot
* [x] Perform manual rollbacks and validate recovery
* [x] Understand automatic rollback and failure protection

[#know_section]
[#atomic_updates]
== 4.1 Know: Solving Risky Updates with Atomic Operations

=== The Business Challenge
ManufacturingCo struggles with updates in the field. Traditional methods often fail, leading to costly downtime.

[cols="1,2a", options="header"]
|===
| Challenge | Impact on ManufacturingCo
| **Update Failures** | 15% of updates fail and require onsite IT.
| **Downtime** | 2–4 hours of downtime per failure.
| **Debugging** | Field debugging is difficult and unpredictable due to network issues.
|===

**The Real Issue:** Traditional package-based updates mutate a live system. If something breaks, you are stuck diagnosing a corrupted production appliance.

=== Atomic Updates: The New Model



RHEL Image Mode replaces package updates with **atomic image deployment**. Each system maintains two bootable states:

[cols="1,1,2a", options="header"]
|===
| State | Name | Description
| **A** | **Active** | The current boot version (e.g., 4.19).
| **B** | **Next Candidate** | The staged version (4.20) waiting for a reboot.
| **Safety** | **Rollback** | If anything fails, the system auto-reverts to A.
|===

**Business Value Comparison**
[cols="1a,1a", options="header"]
|===
| ❌ Traditional Approach | ✅ Image Mode Approach
| 
* Risky in-place mutation.
* 15% failure rate + site visits.
* Manual recovery steps.
| 
* Immutable, versioned upgrade.
* <1% failure rate + auto-rollback.
* Zero downtime risk with instant recovery.
|===

[#show_section]
[#build_4.20]
== 4.2 Show: Build the Updated Image (4.20)

=== Why We're Doing This
To demonstrate a **real update workflow**, we build version 4.20. In production, this would include security fixes, MicroShift payloads, or new app workloads.

[NOTE]
====
Exit from the Bootc VM using Ctrl+D or ENTER "exit" in the terminal to exit the vm and go back to bastion server.
====

=== View the Updated Containerfile
. Inspect the `Containerfile.4.20`:
+
[source,sh,role=execute]
----
cat Containerfile.4.20
----
+
[%collapsible]
====
.Output of `$cat Containerfile.4.20`
[source,dockerfile]
----
FROM localhost/microshift-bootc-embedded:4.19
COPY ./embed_image.sh /usr/bin/
## Needed as bootc-image-builder requires a repo file to be present in the base image.
# in the build.sh with TAG=4.20, we replace the 4.19 repo with the 4.20 repo to allow upgrade MicroShift to 4.20. 
ADD redhat.repo /etc/yum.repos.d/redhat.repo
RUN dnf update --enablerepo=rhel-9-for-$(uname -m)-baseos-eus-rpms --enablerepo=rhel-9-for-x86_64-appstream-eus-rpms -y --releasever=9.6 && \
    dnf clean all
RUN > /usr/lib/containers/storage/image-list.txt
# Pull the container images into /usr/lib/containers/storage:
# - Each image goes into a separate sub-directory
# - Sub-directories are named after the image reference string SHA
# - An image list file maps image references to their name SHA
# First for MicroShift payload
RUN --mount=type=secret,id=pullsecret,dst=/run/secrets/pull-secret.json \
    images="$(jq -r ".images[]" /usr/share/microshift/release/release-"$(uname -m)".json)" ; \
    mkdir -p "${IMAGE_STORAGE_DIR}" ; \
    for img in ${images} ; do \
       /usr/bin/embed_image.sh ${img} --authfile /run/secrets/pull-secret.json ; \
     done 
RUN cat /usr/share/microshift/release/release-"$(uname -m)".json|jq .
# Then for Applications
RUN --mount=type=secret,id=pullsecret,dst=/run/secrets/pull-secret.json <<PULL
    /usr/bin/embed_image.sh docker.io/library/wordpress:6.2.1-apache
    /usr/bin/embed_image.sh docker.io/library/mysql:8.0
PULL
----
====

=== Build the 4.20 Image
. Run the 4.20 build:
+
[source,sh,role=execute]
----
time sudo bash -x build.sh 4.20 2>&1 | tee build-4.20.log
----

[NOTE]
====
**Image Size Reality Check**: Layering 4.20 on 4.19 increases size. In production, you may build **fresh images** instead. Both models work with `bootc switch`.
====

[#upgrade]
== 4.3 Show: Deploy Update Using Disconnected Workflow

=== Why We're Doing This
We are simulating the **real edge**: no registry, no internet, and no onsite IT.

[cols="^1,2,2", options="header"]
|===
| Step | Action | Command
| 1 | **Export** | `skopeo copy ... dir:`
| 2 | **Pack** | `tar -cvf`
| 3 | **Transfer** | `scp`
| 4 | **Switch** | `bootc switch --transport dir`
|===

=== Export and Transfer the 4.20 Image
. Export using `skopeo`:
+
[source,sh,role=execute]
----
mkdir -p /var/tmp/microshift-bootc-4.20
sudo skopeo copy containers-storage:localhost/microshift-bootc-embedded:4.20 dir:/var/tmp/microshift-bootc-4.20
----

. Pack and Check Size (~11GB):
+
[source,sh,role=execute]
----
cd /var/tmp/
time tar cvf microshift-bootc-4.20.tar microshift-bootc-4.20/
du -sh /var/tmp/microshift-bootc-4.20.tar
----

. Copy to Appliance:
+
[source,sh,role=execute]
----
scp /var/tmp/microshift-bootc-4.20.tar redhat@<VM_IP_ADDRESS>:/var/tmp
----

=== Switch and Activate on the Edge Node
. SSH and Unpack:
+
[source,sh,role=execute]
----
ssh redhat@<VM_IP_ADDRESS>
cd /var/tmp/ && time tar -xvf microshift-bootc-4.20.tar
----

. Perform the Switch and Reboot:
+
[source,sh,role=execute]
----
sudo bootc switch --transport dir /var/tmp/microshift-bootc-4.20/
sudo bootc status
sudo bootc upgrade --apply
----

=== Verify Success
[source,sh,role=execute]
----
sudo bootc status
microshift version
systemctl status greenboot-healthcheck.service
----

[#rollback]
== 4.4 Show: Demonstrate Rollback Capability

=== Why Rollback Matters
Rollback provides an instant safety net with zero data loss and no need for field remediation.

. **Check Availability & Perform Rollback**:
+
[source,sh,role=execute]
----
sudo bootc status   # Should show 4.20 (booted) and 4.19 (rollback)
sudo bootc rollback
sudo systemctl reboot
----

. **Verify Reversion**:
+
[source,sh,role=execute]
----
sudo bootc status   # 4.19 should now be booted
microshift version
----

[IMPORTANT]
====
Rollback preserves `/etc`, `/var`, and application data. Only the core OS is reverted.
====

[IMPORTANT]
====
**MicroShift Rollback Considerations:**

This demonstration shows the **bootc rollback capability** for the OS layer. However, **MicroShift data and state are not automatically restored** when performing a bootc rollback. This is a **design decision**, not a known issue.

* **Restore data for older version:** If you need to restore MicroShift workloads, data, or configuration after an OS rollback, you can restore data for the older MicroShift version using MicroShift backup and restore procedures. See link:https://docs.redhat.com/en/documentation/red_hat_build_of_microshift/4.20/html/backup_and_restore/backing-up-and-restoring-data#microshift-restoring-data-backups-manually_microshift-backup-and-restore[Red Hat build of MicroShift 4.20 Backup and Restore documentation^] for details.
* **Downgrade limitations:** Downgrades other than automatic rollbacks are not supported. See link:https://docs.redhat.com/en/documentation/red_hat_build_of_microshift/4.20/html-single/updating/index#microshift-updates-rpm-ostree_microshift-update-rpms-ostree[Red Hat build of MicroShift 4.20 Updating documentation^] for details.
====

[#validation]
== 4.5 Validation: Update and Rollback Verified
* [ ] 4.20 deployed successfully
* [ ] Greenboot reports healthy
* [ ] Pods continued running
* [ ] Rolled back to 4.19 without onsite intervention

[#delta_updates]
== 4.6 Know: Experimental: Delta Updates for Low-Bandwidth
Disconnected sites often have limited bandwidth. **Delta updates** reduce GB-sized moves down to <500MB by only transferring what changed.

[NOTE]
====
Delta updates are **experimental today** (see link:https://issues.redhat.com/browse/RHELBU-3333[RHELBU-3333^]).
====

---
**Next:** Proceed to xref:module-05.adoc[Module 5: Business Outcomes & Resources]

